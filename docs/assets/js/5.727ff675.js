(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{745:function(s,t,a){s.exports=a.p+"assets/img/image-20201212154706357.1e132d92.png"},746:function(s,t,a){s.exports=a.p+"assets/img/image-20201212154740659.cc377536.png"},747:function(s,t,a){s.exports=a.p+"assets/img/image-20201212154814105.93af12fe.png"},748:function(s,t,a){s.exports=a.p+"assets/img/image-20201212170426134.90a806eb.png"},749:function(s,t,a){s.exports=a.p+"assets/img/image-20201212170455199.f1ad3da3.png"},750:function(s,t,a){s.exports=a.p+"assets/img/image-20201212170518553.14a67cdc.png"},751:function(s,t,a){s.exports=a.p+"assets/img/image-20201212170546847.202a8c92.png"},752:function(s,t,a){s.exports=a.p+"assets/img/image-20201212170611769.ab92ddf3.png"},753:function(s,t,a){s.exports=a.p+"assets/img/image-20201212172302910.8377482b.png"},754:function(s,t,a){s.exports=a.p+"assets/img/image-20201212172319717.4b2a2e4d.png"},755:function(s,t,a){s.exports=a.p+"assets/img/image-20201212190635680.d9e996b4.png"},756:function(s,t,a){s.exports=a.p+"assets/img/image-20201212190937246.3b7efcf4.png"},757:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191002426.3ae90581.png"},758:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191035441.f7f270aa.png"},759:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191050616.fe101b60.png"},760:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191108482.25c54ff9.png"},761:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191631509.a5278479.png"},762:function(s,t,a){s.exports=a.p+"assets/img/image-20201212191734090.f3852d64.png"},847:function(s,t,a){"use strict";a.r(t);var _=a(25),n=Object(_.a)({},(function(){var s=this,t=s.$createElement,_=s._self._c||t;return _("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[_("h3",{attrs:{id:"高可用架构类问题"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#高可用架构类问题"}},[s._v("#")]),s._v(" 高可用架构类问题")]),s._v(" "),_("p",[s._v("常见问题")]),s._v(" "),_("ol",[_("li",[s._v("MySQL 的主从复制是如何工作的")]),s._v(" "),_("li",[s._v("比较一下基于 GTID 方式的复制和基于日志点的复制。")]),s._v(" "),_("li",[s._v("比较一下 MMM 和 MHA 两种高可用架构的优缺点")]),s._v(" "),_("li",[s._v("如何减小主从复制的延迟")]),s._v(" "),_("li",[s._v("说说你对 MGR 的认识")]),s._v(" "),_("li",[s._v("如何解决数据库读/写负载大的问题？")])]),s._v(" "),_("ul",[_("li",[_("p",[s._v("MySQL的主从复制是如何工作的？\n知识点")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("MySQL主从复制的实现原理")]),s._v(" "),_("p",[_("img",{attrs:{src:a(745),alt:"image-20201212154706357"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(746),alt:"image-20201212154740659"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(747),alt:"image-20201212154814105"}})])]),s._v(" "),_("li",[_("p",[s._v("MySQL主从复制的配置步骤")]),s._v(" "),_("p",[s._v("在MASTER服务器上的操作")]),s._v(" "),_("ol",[_("li",[s._v("开启binlog（必须）开启 gtid（可选）")]),s._v(" "),_("li",[s._v("建立同步所用的数据库账号")]),s._v(" "),_("li",[s._v("使用 master_data 参数备份数据库")]),s._v(" "),_("li",[s._v("把备份文件转输到 Slave 服务器")])]),s._v(" "),_("p",[s._v("在Slave服务器上的操作")]),s._v(" "),_("ol",[_("li",[s._v("开启binlog（可选）开启gtid（可选）")]),s._v(" "),_("li",[s._v("恢复 Master 上的备份数据库")]),s._v(" "),_("li",[s._v("使用 Change master 配置链路")]),s._v(" "),_("li",[s._v("使用 start slave 启动复制")])]),s._v(" "),_("div",{staticClass:"language-sh extra-class"},[_("pre",{pre:!0,attrs:{class:"language-sh"}},[_("code",[_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01: 192.168.1.91")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-02: 192.168.1.92")]),s._v("\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-02")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @@version"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),s._v(".11\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @@version"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),s._v(".11\n\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" show variables like "),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'log_bin%'")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \nvariable_name value \nlog_bin       ON\nlog_bin_basename  /home/mysql/sql_log/mysql-bin\n1oq_bin_index     /home/mysql/sql_1og/mysq1-bin.index\nloq_bin_trust_function_creators OFF\nlog_bin_use_v1row_events        OFF\n\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" show variables like "),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gtid_mode'")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nvariable_name  value\ngtid_mode      ON\n\n$ "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" /etc/my.cnf\n"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),_("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default_authentication_plugin")]),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql_native_password'")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replice")]),s._v("\nserver-id "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),s._v("\nrelay_log "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysqld-relay-bin\ngtid_mode "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\nenforce-gtid-consistency\nlog-slave-updates "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\nmaster_info_repository "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TABLE\nrelay_log_info_repository "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TABLE\n\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" create user repl@"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.1.%'")]),s._v(" identified by "),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" grant replication slave on *.* to repl@"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.1.%'")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from stock.stock where "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("   product_id  category_id  warehouse_id  count  modified_time\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("2030")]),s._v("        "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("            "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("             "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("     "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v("-08-31 09:51:22\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份（master-data=2 备份日志点）")]),s._v("\n$ mysqldump --single-transaction -uroot -p --routines --triggers --events --master-data"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" --all-databases "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" master.sql\n$ "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("less")]),s._v(" master.sql\n--  MysQL dump "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.13")]),s._v(" Distrib "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),s._v(".11，for Linux（x86 "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("）\n-- Host：localhost Database：\n-- Server versior "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),s._v(".11\n"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n-- GTID state at the beginning of the backup\n-- SET@@GLOBAL.GTID_PURGED-/*80000"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'+'")]),s._v("*/"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'17d353ea-7d31-11e8-9ee5-e660752e2844：1-12，\n-- Position to start replication or point-in-time recovery from\n-- CHANGE MASTER TO MASTER-LOG-FILE-'")]),s._v(" mysql-bin. 000012"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("', MASTER LOG_Pos=710;\n-- current Database: mysal\n\n$ scp master.sql root@192.168.1.92:/root\n\n# mysql-02\n$ ls\nmaster.sql\n$ mysql -uroot -p < master.sql # 初始化数据库\nmysql> change master to master_host='")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.91"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("', master_log_file='")]),s._v("mysql-bin.000012"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("', MASTER_LOG_POS=710; # 基于日志点的复制\nmysql> show slave status\\G\nmysql> start slave user='")]),s._v("repl"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("' password='")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> show slave status\\G\nSlave_IO_Running:  Yes\nSlave_SQL_Running: Yes\n\n\n\n\n\n### 半同步复制 ###\n# https://www.cnblogs.com/ivictor/p/5735580.html\n# mysql-01\nmysql> show plugins;\nmysql> INSTALL PLUGIN rpl_semi_sync_master SONAME '")]),s._v("semisync_master.so"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> show plugins;\nmysql> show variables like '")]),s._v("rpl%"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> set persist rpl_semi_sync_master_timemout=500;\nmysql> set persist rpl_semi_sync_master_enabled=ON;\n\n# mysql-02\nmysql> INSTALL PLUGIN rpl_semi_sync_slave SONAME '")]),s._v("semisync_slave.so"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> show plugins;\nmysql> show variables like '")]),s._v("rpl%"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> set persist rpl_semi_sync_slave_enabled=ON;\nmysql> stop slave io_thread;\nmysql> start slave io_thread user='")]),s._v("repl"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("' password='")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nmysql> show slave status\\G\nmysql> show global status like '")]),s._v("rpl%"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nRpl_semi_sync_master_status   ON\n\n# mysql-01\nmysql> show global status like '")]),s._v("rpl%"),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("';\nRpl_semi_sync_master_status   ON\nmysql> show variables like '")]),s._v("rpl%'"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" update stock.stock "),_("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" where "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 很快就返回")]),s._v("\n\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" persist "),_("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rpl_semi_sync_master_timeout")]),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试超时")]),s._v("\n\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-02")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" stop slave io_thread"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消从库的 IO 进程")]),s._v("\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" update stock.stock "),_("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" where "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行时间非常长")]),s._v("\n\n")])])])])])]),s._v(" "),_("li",[_("p",[s._v("比较 GTID 复制和基于日志点的复制")]),s._v(" "),_("p",[s._v("知识点")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("什么是基于日志点的复制")]),s._v(" "),_("p",[s._v("传统的主从复制方式")]),s._v(" "),_("p",[s._v("Slave 请求 Master 的增量日志依赖于日志偏移量")]),s._v(" "),_("p",[s._v("配置链路时需指定 master_log_file 和 master_log_pos 参数")])]),s._v(" "),_("li",[_("p",[s._v("什么是基于 GTID 的复制")]),s._v(" "),_("p",[s._v("GTID = source_id:transaction_id")]),s._v(" "),_("p",[s._v("Slave 增量同步 Master 的数据依赖于其未同步的事务 ID")]),s._v(" "),_("p",[s._v("配置复制链路时，Slave 可以根据已经同步的事务 ID 继续自动同步")])]),s._v(" "),_("li",[_("p",[s._v("这两种复制方式各自的特点")]),s._v(" "),_("table",[_("thead",[_("tr",[_("th",[s._v("基于日志的复制")]),s._v(" "),_("th",[s._v("基于GTID的复制")])])]),s._v(" "),_("tbody",[_("tr",[_("td",[s._v("兼容性好")]),s._v(" "),_("td",[s._v("同老版本MySQL及MariaDB不兼容")])]),s._v(" "),_("tr",[_("td",[s._v("支持MMM和MHA架构")]),s._v(" "),_("td",[s._v("仅支持MHA架构")])]),s._v(" "),_("tr",[_("td",[s._v("主备切换后很难找到新的同步点")]),s._v(" "),_("td",[s._v("基于事务ID复制，可以很方便的找到未完成同步的事务 ID")])]),s._v(" "),_("tr",[_("td",[s._v("可以方便的跳过复制错误")]),s._v(" "),_("td",[s._v("只能通过置入空事务的方式跳过错误")])])])]),s._v(" "),_("p",[s._v("两种复制方式如可选择")]),s._v(" "),_("ul",[_("li",[s._v("需要兼容老版本MySQL及MariaDB")]),s._v(" "),_("li",[s._v("基于日志点的复制")]),s._v(" "),_("li",[s._v("需要使用MMM架构")]),s._v(" "),_("li",[s._v("基于日志点的复制")]),s._v(" "),_("li",[s._v("其它各种情况")]),s._v(" "),_("li",[s._v("优先选择基于GTID的复制")])])])])]),s._v(" "),_("li",[_("p",[s._v("比较一下MMM和MHA两种高可用复制架构\n知识点")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("MMM和MHA两种架构的作用")]),s._v(" "),_("p",[s._v("对主从复制集群中的MASTER的健康进行监控\n当MASTER宕机后把写VIP迁移到新的MASTER\n重新配置集群中的其它Slave对新的MASTER同步")])]),s._v(" "),_("li",[_("p",[s._v("MMM架构的优缺点及适用场景")]),s._v(" "),_("p",[_("img",{attrs:{src:a(748),alt:"image-20201212170426134"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(749),alt:"image-20201212170455199"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(750),alt:"image-20201212170518553"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(751),alt:"image-20201212170546847"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(752),alt:"image-20201212170611769"}})]),s._v(" "),_("p",[_("strong",[s._v("MMM 架构的故障转移步骤")])]),s._v(" "),_("p",[s._v("SLAVE服务器上的操作")]),s._v(" "),_("ul",[_("li",[s._v("完成原主上已复制日志的恢复")]),s._v(" "),_("li",[s._v("使用Change Master命令配置新主")])]),s._v(" "),_("p",[s._v("主备服务器上的操作")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("设置read only=off")])]),s._v(" "),_("li",[_("p",[s._v("迁移写VIP到新主服务器")]),s._v(" "),_("table",[_("thead",[_("tr",[_("th",[s._v("资源")]),s._v(" "),_("th",[s._v("数量")]),s._v(" "),_("th",[s._v("说明")])])]),s._v(" "),_("tbody",[_("tr",[_("td",[s._v("主 DB")]),s._v(" "),_("td",[s._v("2")]),s._v(" "),_("td",[s._v("用于主备模式的主主复制配置")])]),s._v(" "),_("tr",[_("td",[s._v("从 DB")]),s._v(" "),_("td",[s._v("0~N")]),s._v(" "),_("td",[s._v("可以配置0台或多台从服务器")])]),s._v(" "),_("tr",[_("td",[s._v("IP 地址")]),s._v(" "),_("td",[s._v("2n+1")]),s._v(" "),_("td",[s._v("N为MySQL服务器的数量")])]),s._v(" "),_("tr",[_("td",[s._v("监控用户")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于监控数据库状态的MySQL用户（replication client）")])]),s._v(" "),_("tr",[_("td",[s._v("代理用户")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于MMM的agent端用于改变read_only状态"),_("br"),s._v("（super，replication client，process）")])]),s._v(" "),_("tr",[_("td",[s._v("复制用户")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于配置MySQL复制的MySQL用户（replication slave）")])])])])])])])])]),s._v(" "),_("li",[_("p",[s._v("MMM 架构的配置步骤")]),s._v(" "),_("ul",[_("li",[s._v("配置主主复制的集群架构")]),s._v(" "),_("li",[s._v("安装Centos的YUM扩展包")]),s._v(" "),_("li",[s._v("安装所需的Perl支持包")]),s._v(" "),_("li",[s._v("安装MMM工具包")]),s._v(" "),_("li",[s._v("配置并启用MMM服务")])])]),s._v(" "),_("li",[_("p",[s._v("MMM架构的优点")]),s._v(" "),_("ul",[_("li",[s._v("提供了读写VIP的配置，使读写请求都可以达到高可用。")]),s._v(" "),_("li",[s._v("工具包相对完善，不需要额外开发脚本。")]),s._v(" "),_("li",[s._v("完成故障转移后，可以持续对MySQL集群进行高可用监控")])])]),s._v(" "),_("li",[_("p",[s._v("MMM架构的缺点")]),s._v(" "),_("ul",[_("li",[s._v("故障切换简单粗暴易丢事务")]),s._v(" "),_("li",[s._v("主备使用5.7以后的半同步复制")]),s._v(" "),_("li",[s._v("不支持GTID的复制方式")]),s._v(" "),_("li",[s._v("社区不活越，很久未更新版本")]),s._v(" "),_("li",[s._v("自行修改perl脚本实现")])])]),s._v(" "),_("li",[_("p",[s._v("MMM架构的适用场景")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("使用基于日志点的主从复制方式")])]),s._v(" "),_("li",[_("p",[s._v("使用主主复制的架构")])]),s._v(" "),_("li",[_("p",[s._v("需要考虑读高可用的场景")]),s._v(" "),_("p",[_("img",{attrs:{src:a(753),alt:"image-20201212172302910"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(754),alt:"image-20201212172319717"}})])])])]),s._v(" "),_("li",[_("p",[s._v("MHA  架构的故障转移步骤")]),s._v(" "),_("ul",[_("li",[s._v("选举具有最新更新的Slave")]),s._v(" "),_("li",[s._v("尝试从宕机的master保存二进制日志")]),s._v(" "),_("li",[s._v("应用差异的中继日志到其它Slave")]),s._v(" "),_("li",[s._v("应用从Master保存的二进制日志")]),s._v(" "),_("li",[s._v("提升选举的Slave为新的Master")]),s._v(" "),_("li",[s._v("配置其它Slave向新的Master同步")])])]),s._v(" "),_("li",[_("p",[s._v("MHA 架构的需要的资源")]),s._v(" "),_("table",[_("thead",[_("tr",[_("th",[s._v("资源")]),s._v(" "),_("th",[s._v("数量")]),s._v(" "),_("th",[s._v("说明")])])]),s._v(" "),_("tbody",[_("tr",[_("td",[s._v("主 DB")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于初始主从复制的Master服务器")])]),s._v(" "),_("tr",[_("td",[s._v("从 DB")]),s._v(" "),_("td",[s._v("2~N")]),s._v(" "),_("td",[s._v("可以配置2台或多台从服务器")])]),s._v(" "),_("tr",[_("td",[s._v("IP 地址")]),s._v(" "),_("td",[s._v("n+2")]),s._v(" "),_("td",[s._v("N为MySQL服务器的数量")])]),s._v(" "),_("tr",[_("td",[s._v("监控用户")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于监控数据库状态的MySQL用户（all privileges）")])]),s._v(" "),_("tr",[_("td",[s._v("复制用户")]),s._v(" "),_("td",[s._v("1")]),s._v(" "),_("td",[s._v("用于配置MySQL复制的MySQL用户（replication slave）")])])])])]),s._v(" "),_("li",[_("p",[s._v("MHA 架构的配置步骤")]),s._v(" "),_("ul",[_("li",[s._v("配置一主多从的复制架构")]),s._v(" "),_("li",[s._v("安装CentOS的Yum扩展源及依赖包")]),s._v(" "),_("li",[s._v("配置集群内各主机的SSH免认证")]),s._v(" "),_("li",[s._v("在各节点安装mha_node软件")]),s._v(" "),_("li",[s._v("在管理节点安装mha_manager")]),s._v(" "),_("li",[s._v("配置并启动MHA管理进程")])]),s._v(" "),_("div",{staticClass:"language-sh extra-class"},[_("pre",{pre:!0,attrs:{class:"language-sh"}},[_("code",[_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01: 192.168.1.91")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-02: 192.168.1.92")]),s._v("\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-03: 192.168.1.93")]),s._v("\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01")]),s._v("\nmysql"),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" show slave hosts:\nserver_id Host Port  Master_id  Slave_UUID\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9002")]),s._v("           "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("  "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),s._v("       9a94313f-ad7c-11e8-989b-080027e24cof\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9003")]),s._v("           "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("  "),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("9001")]),s._v("       207dbe49-ad7d-11e8-8e47-0800275e4498\n$ systemctl status firewalld\ninactive\n$ "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" /etc/hosts\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.91 mysql-01\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.92 mysql-02\n"),_("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.93 mysql-03\n$ "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" auth /etc/my.cnf\n"),_("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default_authentication_plugin")]),_("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),_("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql_native_password'")]),s._v("\n$ ssh-keygen\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-02")]),s._v("\n$ ssh-keygen\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-03")]),s._v("\n$ ssh-keygen\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92\n$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93\n\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql-01, mysql-02, mysql-03")]),s._v("\n$ yum "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-DBD-MySQL ncftp perl-DBI.x86\n$ "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh mha4mysql-node-0.57-0.e17.noarch.rpm\n\n"),_("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控节点（如 mysql-03）")]),s._v("\n$ yum -y "),_("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-Config-Tiny.noarch perl-Time-HiRes.x84_64 perl-Paralel-ForkManager perl-Log-Dispatch-Perl.noarch\n$ yum -y mha4mysql-manager-0.57-0.el7.noarch.rpm\n")])])])]),s._v(" "),_("li",[_("p",[s._v("MHA 架构的优点")]),s._v(" "),_("ul",[_("li",[s._v("支持 GTID 的复制方式和基于日志点的复制方式")]),s._v(" "),_("li",[s._v("可从多个 Slave 中选举最适合的新 Master")]),s._v(" "),_("li",[s._v("会尝试从旧 Master 中尽可能多的保存未同步日志")])])]),s._v(" "),_("li",[_("p",[s._v("MHA 架构的缺点")]),s._v(" "),_("ul",[_("li",[s._v("未必能获取到旧主未同步的日志")]),s._v(" "),_("li",[s._v("主备使用 5.7 以后的半同步复制")]),s._v(" "),_("li",[s._v("需要自行开发写 VIP 转移脚本")]),s._v(" "),_("li",[s._v("只监控 Master 而没有对 Slave 实现高可用的办法")])])]),s._v(" "),_("li",[_("p",[s._v("MHA 架构的适用场景")]),s._v(" "),_("ul",[_("li",[s._v("使用基于 GTID 的复制方式")]),s._v(" "),_("li",[s._v("使用一主多从的复制架构")]),s._v(" "),_("li",[s._v("希望更少的数据丢失的场景")])])]),s._v(" "),_("li",[_("p",[s._v("如何减少主从复制延迟")]),s._v(" "),_("p",[s._v("知识点")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("主从复制延迟产生的原因")]),s._v(" "),_("p",[_("img",{attrs:{src:a(755),alt:"image-20201212190635680"}})])]),s._v(" "),_("li",[_("p",[s._v("几种减少主从延迟的处理方法")]),s._v(" "),_("p",[s._v("大事务：数万行的数据更新以及对大表的DDL操作")]),s._v(" "),_("p",[s._v("化大事务为小事务，分批更新数据。\n使用pt-online-schema-change工具进行DDL操作。")]),s._v(" "),_("p",[s._v("网络延迟\n减小单次事务处理的数据量以减少产生的日志文件大小。\n减少主上所同步的Slave的数量。")]),s._v(" "),_("p",[s._v("由主上多线程的写入从上单线程恢复引起的延迟")]),s._v(" "),_("p",[s._v("使用MySQL5.7之后的多线程复制")]),s._v(" "),_("p",[s._v("使用MGR复制架构。")])])])]),s._v(" "),_("li",[_("p",[s._v("说说你对 MGR 复制的理解")]),s._v(" "),_("p",[s._v("知识点")]),s._v(" "),_("ul",[_("li",[_("p",[s._v("什么是 MGR 复制？")]),s._v(" "),_("p",[s._v("MGR（MySQL Group Replication）\n是官方推出的一种基于Paxos协议的复制。\n是一种不同于异步复制的多Master复制集群。")]),s._v(" "),_("p",[_("img",{attrs:{src:a(756),alt:"image-20201212190937246"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(757),alt:"image-20201212191002426"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(758),alt:"image-20201212191035441"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(759),alt:"image-20201212191050616"}})]),s._v(" "),_("p",[_("img",{attrs:{src:a(760),alt:"image-20201212191108482"}})]),s._v(" "),_("table",[_("thead",[_("tr",[_("th",[s._v("集群大小")]),s._v(" "),_("th",[s._v("投票数")]),s._v(" "),_("th",[s._v("允许宕机数量")])])]),s._v(" "),_("tbody",[_("tr",[_("td",[s._v("3")]),s._v(" "),_("td",[s._v("2")]),s._v(" "),_("td",[s._v("1")])]),s._v(" "),_("tr",[_("td",[s._v("4")]),s._v(" "),_("td",[s._v("3")]),s._v(" "),_("td",[s._v("1")])]),s._v(" "),_("tr",[_("td",[s._v("5")]),s._v(" "),_("td",[s._v("3")]),s._v(" "),_("td",[s._v("2")])]),s._v(" "),_("tr",[_("td",[s._v("6")]),s._v(" "),_("td",[s._v("4")]),s._v(" "),_("td",[s._v("2")])]),s._v(" "),_("tr",[_("td",[s._v("7")]),s._v(" "),_("td",[s._v("4")]),s._v(" "),_("td",[s._v("3")])]),s._v(" "),_("tr",[_("td",[s._v("8")]),s._v(" "),_("td",[s._v("5")]),s._v(" "),_("td",[s._v("3")])]),s._v(" "),_("tr",[_("td",[s._v("9")]),s._v(" "),_("td",[s._v("5")]),s._v(" "),_("td",[s._v("4")])])])])]),s._v(" "),_("li",[_("p",[s._v("如何使用 MGR 复制")]),s._v(" "),_("p",[s._v("MGR 复制架构的配置步骤")]),s._v(" "),_("ul",[_("li",[s._v("安装group-replication插件")]),s._v(" "),_("li",[s._v("在第一个实列上建立复制用户")]),s._v(" "),_("li",[s._v("配置第一个组实例")]),s._v(" "),_("li",[s._v("把其它实例加入组")])])]),s._v(" "),_("li",[_("p",[s._v("当前 MGR 的优缺点")]),s._v(" "),_("p",[s._v("优点\nGroup Replication组内成员间基本无延迟。\n可以支持多写操作，读写服务高可用")]),s._v(" "),_("p",[s._v("数据强一致，可以保证不丢失事务。")]),s._v(" "),_("p",[s._v("缺点")]),s._v(" "),_("p",[s._v("只支持InnoDB存储引擎的表，并且每个表上必须有一个主键")]),s._v(" "),_("p",[s._v("单主模式下很难确认下一个PRIMARY\n只能用在gtid模式的复制形式下，且日志格式必需为row")])])]),s._v(" "),_("ul",[_("li",[s._v("MGR复制架构的适用场景\n"),_("ul",[_("li",[s._v("对主从延迟十分敏感的应用场景。")]),s._v(" "),_("li",[s._v("希望可以对读写提供高可用的场景。")]),s._v(" "),_("li",[s._v("希望可以保证数据强一致的场景。")])])])]),s._v(" "),_("p",[_("img",{attrs:{src:a(761),alt:"image-20201212191631509"}})]),s._v(" "),_("p",[s._v("为原DB增加Slave服务器")]),s._v(" "),_("p",[s._v("进行读写分离，把读分担到Slave")]),s._v(" "),_("p",[s._v("增加数据库中间层，进行负载均衡")]),s._v(" "),_("p",[_("img",{attrs:{src:a(762),alt:"image-20201212191734090"}})])])])])}),[],!1,null,null,null);t.default=n.exports}}]);