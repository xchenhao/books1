<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>高可用架构类问题 | 不可思议</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="xchenhao.gitee.io">
    <link rel="preload" href="/assets/css/0.styles.dcdd4981.css" as="style"><link rel="preload" href="/assets/js/app.1006bb4e.js" as="script"><link rel="preload" href="/assets/js/3.ecb1f808.js" as="script"><link rel="preload" href="/assets/js/5.2e521b8e.js" as="script"><link rel="prefetch" href="/assets/js/10.839e68ba.js"><link rel="prefetch" href="/assets/js/11.fc80baa0.js"><link rel="prefetch" href="/assets/js/12.589f9fd7.js"><link rel="prefetch" href="/assets/js/13.05c79365.js"><link rel="prefetch" href="/assets/js/14.3f40d575.js"><link rel="prefetch" href="/assets/js/15.83ad4380.js"><link rel="prefetch" href="/assets/js/16.d6ca58c3.js"><link rel="prefetch" href="/assets/js/17.99f7357b.js"><link rel="prefetch" href="/assets/js/18.36262359.js"><link rel="prefetch" href="/assets/js/19.5dcf3e21.js"><link rel="prefetch" href="/assets/js/20.a99b697c.js"><link rel="prefetch" href="/assets/js/21.30c881d7.js"><link rel="prefetch" href="/assets/js/22.f40c1f7b.js"><link rel="prefetch" href="/assets/js/23.856941a8.js"><link rel="prefetch" href="/assets/js/24.60b33392.js"><link rel="prefetch" href="/assets/js/25.29f87303.js"><link rel="prefetch" href="/assets/js/26.d9e16ac7.js"><link rel="prefetch" href="/assets/js/27.d1d16327.js"><link rel="prefetch" href="/assets/js/28.aaf2400b.js"><link rel="prefetch" href="/assets/js/29.0a455a29.js"><link rel="prefetch" href="/assets/js/30.b90ce8de.js"><link rel="prefetch" href="/assets/js/31.8341ab32.js"><link rel="prefetch" href="/assets/js/32.a94fcf64.js"><link rel="prefetch" href="/assets/js/33.bb3d7b42.js"><link rel="prefetch" href="/assets/js/34.438344c9.js"><link rel="prefetch" href="/assets/js/35.c8b584ab.js"><link rel="prefetch" href="/assets/js/36.50f683dc.js"><link rel="prefetch" href="/assets/js/37.245d64dd.js"><link rel="prefetch" href="/assets/js/38.6d59a42e.js"><link rel="prefetch" href="/assets/js/39.7ddd8db3.js"><link rel="prefetch" href="/assets/js/4.bd7a8752.js"><link rel="prefetch" href="/assets/js/40.47625021.js"><link rel="prefetch" href="/assets/js/41.c423587d.js"><link rel="prefetch" href="/assets/js/42.dd2632a5.js"><link rel="prefetch" href="/assets/js/43.c6e6b740.js"><link rel="prefetch" href="/assets/js/44.83408d66.js"><link rel="prefetch" href="/assets/js/45.58439efe.js"><link rel="prefetch" href="/assets/js/46.2abb227b.js"><link rel="prefetch" href="/assets/js/47.f8697add.js"><link rel="prefetch" href="/assets/js/48.1f8e7827.js"><link rel="prefetch" href="/assets/js/49.e1d50013.js"><link rel="prefetch" href="/assets/js/50.de0cdf28.js"><link rel="prefetch" href="/assets/js/51.01e44d38.js"><link rel="prefetch" href="/assets/js/52.199f46fb.js"><link rel="prefetch" href="/assets/js/53.3da97659.js"><link rel="prefetch" href="/assets/js/54.5e34d71e.js"><link rel="prefetch" href="/assets/js/55.dc502682.js"><link rel="prefetch" href="/assets/js/6.be562cc9.js"><link rel="prefetch" href="/assets/js/7.d91fc515.js"><link rel="prefetch" href="/assets/js/8.de6f9e5c.js"><link rel="prefetch" href="/assets/js/9.7b7214cf.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.ed09d42e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dcdd4981.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active no-logo home-link"><!----> <span class="site-name">不可思议</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          数据库
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          语言
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Hive.html" title="Hive" class="sidebar-link">Hive</a></li><li><a href="/ODPS.html" title="ODPS" class="sidebar-link">ODPS</a></li><li><a href="/mongodb/MongoBasis.html" title="MongoDB 基础" class="sidebar-link">MongoDB 基础</a></li><li><a href="/mongodb/MongoBegin.html" title="MongoDB 起步" class="sidebar-link">MongoDB 起步</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Shell</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><a href="/books-note.html" title="读书笔记" class="sidebar-link">读书笔记</a></li><li><a href="/update_log.html" title="更新记录" class="sidebar-link">更新记录</a></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h3 id="高可用架构类问题"><a href="#高可用架构类问题" class="header-anchor">#</a> 高可用架构类问题</h3> <p>常见问题</p> <ol><li>MySQL 的主从复制是如何工作的</li> <li>比较一下基于 GTID 方式的复制和基于日志点的复制。</li> <li>比较一下 MMM 和 MHA 两种高可用架构的优缺点</li> <li>如何减小主从复制的延迟</li> <li>说说你对 MGR 的认识</li> <li>如何解决数据库读/写负载大的问题？</li></ol> <ul><li><p>MySQL的主从复制是如何工作的？
知识点</p> <ul><li><p>MySQL主从复制的实现原理</p> <p><img src="/assets/img/image-20201212154706357.1e132d92.png" alt="image-20201212154706357"></p> <p><img src="/assets/img/image-20201212154740659.cc377536.png" alt="image-20201212154740659"></p> <p><img src="/assets/img/image-20201212154814105.93af12fe.png" alt="image-20201212154814105"></p></li> <li><p>MySQL主从复制的配置步骤</p> <p>在MASTER服务器上的操作</p> <ol><li>开启binlog（必须）开启 gtid（可选）</li> <li>建立同步所用的数据库账号</li> <li>使用 master_data 参数备份数据库</li> <li>把备份文件转输到 Slave 服务器</li></ol> <p>在Slave服务器上的操作</p> <ol><li>开启binlog（可选）开启gtid（可选）</li> <li>恢复 Master 上的备份数据库</li> <li>使用 Change master 配置链路</li> <li>使用 start slave 启动复制</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># mysql-01: 192.168.1.91</span>
<span class="token comment"># mysql-02: 192.168.1.92</span>

<span class="token comment"># mysql-02</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@version<span class="token punctuation">;</span>
<span class="token number">8.0</span>.11

<span class="token comment"># mysql-01</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@version<span class="token punctuation">;</span>
<span class="token number">8.0</span>.11

mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'log_bin%'</span><span class="token punctuation">;</span> 
variable_name value 
log_bin       ON
log_bin_basename  /home/mysql/sql_log/mysql-bin
1oq_bin_index     /home/mysql/sql_1og/mysq1-bin.index
loq_bin_trust_function_creators OFF
log_bin_use_v1row_events        OFF

mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'gtid_mode'</span><span class="token punctuation">;</span>
variable_name  value
gtid_mode      ON

$ <span class="token function">more</span> /etc/my.cnf
<span class="token punctuation">..</span>.
<span class="token assign-left variable">default_authentication_plugin</span><span class="token operator">=</span><span class="token string">'mysql_native_password'</span>
<span class="token punctuation">..</span>.
<span class="token comment"># Replice</span>
server-id <span class="token operator">=</span> <span class="token number">9001</span>
relay_log <span class="token operator">=</span> mysqld-relay-bin
gtid_mode <span class="token operator">=</span> on
enforce-gtid-consistency
log-slave-updates <span class="token operator">=</span> on
master_info_repository <span class="token operator">=</span> TABLE
relay_log_info_repository <span class="token operator">=</span> TABLE

mysql<span class="token operator">&gt;</span> create user repl@<span class="token string">'192.168.1.%'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> grant replication slave on *.* to repl@<span class="token string">'192.168.1.%'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from stock.stock where <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">id</span>   product_id  category_id  warehouse_id  count  modified_time
<span class="token number">1</span>    <span class="token number">2030</span>        <span class="token number">9</span>            <span class="token number">1</span>             <span class="token number">10</span>     <span class="token number">2018</span>-08-31 09:51:22

<span class="token comment"># 备份（master-data=2 备份日志点）</span>
$ mysqldump --single-transaction -uroot -p --routines --triggers --events --master-data<span class="token operator">=</span><span class="token number">2</span> --all-databases <span class="token operator">&gt;</span> master.sql
$ <span class="token function">less</span> master.sql
--  MysQL dump <span class="token number">10.13</span> Distrib <span class="token number">8.0</span>.11，for Linux（x86 <span class="token number">64</span>）
-- Host：localhost Database：
-- Server versior <span class="token number">8.0</span>.11
<span class="token punctuation">..</span>. <span class="token punctuation">..</span>.
-- GTID state at the beginning of the backup
-- SET@@GLOBAL.GTID_PURGED-/*80000<span class="token string">'+'</span>*/<span class="token string">'17d353ea-7d31-11e8-9ee5-e660752e2844：1-12，
-- Position to start replication or point-in-time recovery from
-- CHANGE MASTER TO MASTER-LOG-FILE-'</span> mysql-bin. 000012<span class="token string">', MASTER LOG_Pos=710;
-- current Database: mysal

$ scp master.sql root@192.168.1.92:/root

# mysql-02
$ ls
master.sql
$ mysql -uroot -p &lt; master.sql # 初始化数据库
mysql&gt; change master to master_host='</span><span class="token number">192.168</span>.1.91<span class="token string">', master_log_file='</span>mysql-bin.000012<span class="token string">', MASTER_LOG_POS=710; # 基于日志点的复制
mysql&gt; show slave status\G
mysql&gt; start slave user='</span>repl<span class="token string">' password='</span><span class="token number">123456</span><span class="token string">';
mysql&gt; show slave status\G
Slave_IO_Running:  Yes
Slave_SQL_Running: Yes





### 半同步复制 ###
# https://www.cnblogs.com/ivictor/p/5735580.html
# mysql-01
mysql&gt; show plugins;
mysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME '</span>semisync_master.so<span class="token string">';
mysql&gt; show plugins;
mysql&gt; show variables like '</span>rpl%<span class="token string">';
mysql&gt; set persist rpl_semi_sync_master_timemout=500;
mysql&gt; set persist rpl_semi_sync_master_enabled=ON;

# mysql-02
mysql&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME '</span>semisync_slave.so<span class="token string">';
mysql&gt; show plugins;
mysql&gt; show variables like '</span>rpl%<span class="token string">';
mysql&gt; set persist rpl_semi_sync_slave_enabled=ON;
mysql&gt; stop slave io_thread;
mysql&gt; start slave io_thread user='</span>repl<span class="token string">' password='</span><span class="token number">123456</span><span class="token string">';
mysql&gt; show slave status\G
mysql&gt; show global status like '</span>rpl%<span class="token string">';
Rpl_semi_sync_master_status   ON

# mysql-01
mysql&gt; show global status like '</span>rpl%<span class="token string">';
Rpl_semi_sync_master_status   ON
mysql&gt; show variables like '</span>rpl%'<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> update stock.stock <span class="token builtin class-name">set</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">30</span> where <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 很快就返回</span>

mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> persist <span class="token assign-left variable">rpl_semi_sync_master_timeout</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment"># 测试超时</span>


<span class="token comment"># mysql-02</span>
mysql<span class="token operator">&gt;</span> stop slave io_thread<span class="token punctuation">;</span> <span class="token comment"># 取消从库的 IO 进程</span>

<span class="token comment"># mysql-01</span>
mysql<span class="token operator">&gt;</span> update stock.stock <span class="token builtin class-name">set</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">40</span> where <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 执行时间非常长</span>

</code></pre></div></li></ul></li> <li><p>比较 GTID 复制和基于日志点的复制</p> <p>知识点</p> <ul><li><p>什么是基于日志点的复制</p> <p>传统的主从复制方式</p> <p>Slave 请求 Master 的增量日志依赖于日志偏移量</p> <p>配置链路时需指定 master_log_file 和 master_log_pos 参数</p></li> <li><p>什么是基于 GTID 的复制</p> <p>GTID = source_id:transaction_id</p> <p>Slave 增量同步 Master 的数据依赖于其未同步的事务 ID</p> <p>配置复制链路时，Slave 可以根据已经同步的事务 ID 继续自动同步</p></li> <li><p>这两种复制方式各自的特点</p> <table><thead><tr><th>基于日志的复制</th> <th>基于GTID的复制</th></tr></thead> <tbody><tr><td>兼容性好</td> <td>同老版本MySQL及MariaDB不兼容</td></tr> <tr><td>支持MMM和MHA架构</td> <td>仅支持MHA架构</td></tr> <tr><td>主备切换后很难找到新的同步点</td> <td>基于事务ID复制，可以很方便的找到未完成同步的事务 ID</td></tr> <tr><td>可以方便的跳过复制错误</td> <td>只能通过置入空事务的方式跳过错误</td></tr></tbody></table> <p>两种复制方式如可选择</p> <ul><li>需要兼容老版本MySQL及MariaDB</li> <li>基于日志点的复制</li> <li>需要使用MMM架构</li> <li>基于日志点的复制</li> <li>其它各种情况</li> <li>优先选择基于GTID的复制</li></ul></li></ul></li> <li><p>比较一下MMM和MHA两种高可用复制架构
知识点</p> <ul><li><p>MMM和MHA两种架构的作用</p> <p>对主从复制集群中的MASTER的健康进行监控
当MASTER宕机后把写VIP迁移到新的MASTER
重新配置集群中的其它Slave对新的MASTER同步</p></li> <li><p>MMM架构的优缺点及适用场景</p> <p><img src="/assets/img/image-20201212170426134.90a806eb.png" alt="image-20201212170426134"></p> <p><img src="/assets/img/image-20201212170455199.f1ad3da3.png" alt="image-20201212170455199"></p> <p><img src="/assets/img/image-20201212170518553.14a67cdc.png" alt="image-20201212170518553"></p> <p><img src="/assets/img/image-20201212170546847.202a8c92.png" alt="image-20201212170546847"></p> <p><img src="/assets/img/image-20201212170611769.ab92ddf3.png" alt="image-20201212170611769"></p> <p><strong>MMM 架构的故障转移步骤</strong></p> <p>SLAVE服务器上的操作</p> <ul><li>完成原主上已复制日志的恢复</li> <li>使用Change Master命令配置新主</li></ul> <p>主备服务器上的操作</p> <ul><li><p>设置read only=off</p></li> <li><p>迁移写VIP到新主服务器</p> <table><thead><tr><th>资源</th> <th>数量</th> <th>说明</th></tr></thead> <tbody><tr><td>主 DB</td> <td>2</td> <td>用于主备模式的主主复制配置</td></tr> <tr><td>从 DB</td> <td>0~N</td> <td>可以配置0台或多台从服务器</td></tr> <tr><td>IP 地址</td> <td>2n+1</td> <td>N为MySQL服务器的数量</td></tr> <tr><td>监控用户</td> <td>1</td> <td>用于监控数据库状态的MySQL用户（replication client）</td></tr> <tr><td>代理用户</td> <td>1</td> <td>用于MMM的agent端用于改变read_only状态<br>（super，replication client，process）</td></tr> <tr><td>复制用户</td> <td>1</td> <td>用于配置MySQL复制的MySQL用户（replication slave）</td></tr></tbody></table></li></ul></li></ul></li> <li><p>MMM 架构的配置步骤</p> <ul><li>配置主主复制的集群架构</li> <li>安装Centos的YUM扩展包</li> <li>安装所需的Perl支持包</li> <li>安装MMM工具包</li> <li>配置并启用MMM服务</li></ul></li> <li><p>MMM架构的优点</p> <ul><li>提供了读写VIP的配置，使读写请求都可以达到高可用。</li> <li>工具包相对完善，不需要额外开发脚本。</li> <li>完成故障转移后，可以持续对MySQL集群进行高可用监控</li></ul></li> <li><p>MMM架构的缺点</p> <ul><li>故障切换简单粗暴易丢事务</li> <li>主备使用5.7以后的半同步复制</li> <li>不支持GTID的复制方式</li> <li>社区不活越，很久未更新版本</li> <li>自行修改perl脚本实现</li></ul></li> <li><p>MMM架构的适用场景</p> <ul><li><p>使用基于日志点的主从复制方式</p></li> <li><p>使用主主复制的架构</p></li> <li><p>需要考虑读高可用的场景</p> <p><img src="/assets/img/image-20201212172302910.8377482b.png" alt="image-20201212172302910"></p> <p><img src="/assets/img/image-20201212172319717.4b2a2e4d.png" alt="image-20201212172319717"></p></li></ul></li> <li><p>MHA  架构的故障转移步骤</p> <ul><li>选举具有最新更新的Slave</li> <li>尝试从宕机的master保存二进制日志</li> <li>应用差异的中继日志到其它Slave</li> <li>应用从Master保存的二进制日志</li> <li>提升选举的Slave为新的Master</li> <li>配置其它Slave向新的Master同步</li></ul></li> <li><p>MHA 架构的需要的资源</p> <table><thead><tr><th>资源</th> <th>数量</th> <th>说明</th></tr></thead> <tbody><tr><td>主 DB</td> <td>1</td> <td>用于初始主从复制的Master服务器</td></tr> <tr><td>从 DB</td> <td>2~N</td> <td>可以配置2台或多台从服务器</td></tr> <tr><td>IP 地址</td> <td>n+2</td> <td>N为MySQL服务器的数量</td></tr> <tr><td>监控用户</td> <td>1</td> <td>用于监控数据库状态的MySQL用户（all privileges）</td></tr> <tr><td>复制用户</td> <td>1</td> <td>用于配置MySQL复制的MySQL用户（replication slave）</td></tr></tbody></table></li> <li><p>MHA 架构的配置步骤</p> <ul><li>配置一主多从的复制架构</li> <li>安装CentOS的Yum扩展源及依赖包</li> <li>配置集群内各主机的SSH免认证</li> <li>在各节点安装mha_node软件</li> <li>在管理节点安装mha_manager</li> <li>配置并启动MHA管理进程</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># mysql-01: 192.168.1.91</span>
<span class="token comment"># mysql-02: 192.168.1.92</span>
<span class="token comment"># mysql-03: 192.168.1.93</span>

<span class="token comment"># mysql-01</span>
mysql<span class="token operator">&gt;</span> show slave hosts:
server_id Host Port  Master_id  Slave_UUID
<span class="token number">9002</span>           <span class="token number">3306</span>  <span class="token number">9001</span>       9a94313f-ad7c-11e8-989b-080027e24cof
<span class="token number">9003</span>           <span class="token number">3306</span>  <span class="token number">9001</span>       207dbe49-ad7d-11e8-8e47-0800275e4498
$ systemctl status firewalld
inactive
$ <span class="token function">more</span> /etc/hosts
<span class="token number">192.168</span>.1.91 mysql-01
<span class="token number">192.168</span>.1.92 mysql-02
<span class="token number">192.168</span>.1.93 mysql-03
$ <span class="token function">grep</span> auth /etc/my.cnf
<span class="token assign-left variable">default_authentication_plugin</span><span class="token operator">=</span><span class="token string">'mysql_native_password'</span>
$ ssh-keygen
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93

<span class="token comment"># mysql-02</span>
$ ssh-keygen
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93

<span class="token comment"># mysql-03</span>
$ ssh-keygen
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.91
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.92
$ ssh-copy-id -i /root/.ssh/id_rsa root@192.168.1.93


<span class="token comment"># mysql-01, mysql-02, mysql-03</span>
$ yum <span class="token function">install</span> -y perl-DBD-MySQL ncftp perl-DBI.x86
$ <span class="token function">rpm</span> -ivh mha4mysql-node-0.57-0.e17.noarch.rpm

<span class="token comment"># 监控节点（如 mysql-03）</span>
$ yum -y <span class="token function">install</span> perl-Config-Tiny.noarch perl-Time-HiRes.x84_64 perl-Paralel-ForkManager perl-Log-Dispatch-Perl.noarch
$ yum -y mha4mysql-manager-0.57-0.el7.noarch.rpm
</code></pre></div></li> <li><p>MHA 架构的优点</p> <ul><li>支持 GTID 的复制方式和基于日志点的复制方式</li> <li>可从多个 Slave 中选举最适合的新 Master</li> <li>会尝试从旧 Master 中尽可能多的保存未同步日志</li></ul></li> <li><p>MHA 架构的缺点</p> <ul><li>未必能获取到旧主未同步的日志</li> <li>主备使用 5.7 以后的半同步复制</li> <li>需要自行开发写 VIP 转移脚本</li> <li>只监控 Master 而没有对 Slave 实现高可用的办法</li></ul></li> <li><p>MHA 架构的适用场景</p> <ul><li>使用基于 GTID 的复制方式</li> <li>使用一主多从的复制架构</li> <li>希望更少的数据丢失的场景</li></ul></li> <li><p>如何减少主从复制延迟</p> <p>知识点</p> <ul><li><p>主从复制延迟产生的原因</p> <p><img src="/assets/img/image-20201212190635680.d9e996b4.png" alt="image-20201212190635680"></p></li> <li><p>几种减少主从延迟的处理方法</p> <p>大事务：数万行的数据更新以及对大表的DDL操作</p> <p>化大事务为小事务，分批更新数据。
使用pt-online-schema-change工具进行DDL操作。</p> <p>网络延迟
减小单次事务处理的数据量以减少产生的日志文件大小。
减少主上所同步的Slave的数量。</p> <p>由主上多线程的写入从上单线程恢复引起的延迟</p> <p>使用MySQL5.7之后的多线程复制</p> <p>使用MGR复制架构。</p></li></ul></li> <li><p>说说你对 MGR 复制的理解</p> <p>知识点</p> <ul><li><p>什么是 MGR 复制？</p> <p>MGR（MySQL Group Replication）
是官方推出的一种基于Paxos协议的复制。
是一种不同于异步复制的多Master复制集群。</p> <p><img src="/assets/img/image-20201212190937246.3b7efcf4.png" alt="image-20201212190937246"></p> <p><img src="/assets/img/image-20201212191002426.3ae90581.png" alt="image-20201212191002426"></p> <p><img src="/assets/img/image-20201212191035441.f7f270aa.png" alt="image-20201212191035441"></p> <p><img src="/assets/img/image-20201212191050616.fe101b60.png" alt="image-20201212191050616"></p> <p><img src="/assets/img/image-20201212191108482.25c54ff9.png" alt="image-20201212191108482"></p> <table><thead><tr><th>集群大小</th> <th>投票数</th> <th>允许宕机数量</th></tr></thead> <tbody><tr><td>3</td> <td>2</td> <td>1</td></tr> <tr><td>4</td> <td>3</td> <td>1</td></tr> <tr><td>5</td> <td>3</td> <td>2</td></tr> <tr><td>6</td> <td>4</td> <td>2</td></tr> <tr><td>7</td> <td>4</td> <td>3</td></tr> <tr><td>8</td> <td>5</td> <td>3</td></tr> <tr><td>9</td> <td>5</td> <td>4</td></tr></tbody></table></li> <li><p>如何使用 MGR 复制</p> <p>MGR 复制架构的配置步骤</p> <ul><li>安装group-replication插件</li> <li>在第一个实列上建立复制用户</li> <li>配置第一个组实例</li> <li>把其它实例加入组</li></ul></li> <li><p>当前 MGR 的优缺点</p> <p>优点
Group Replication组内成员间基本无延迟。
可以支持多写操作，读写服务高可用</p> <p>数据强一致，可以保证不丢失事务。</p> <p>缺点</p> <p>只支持InnoDB存储引擎的表，并且每个表上必须有一个主键</p> <p>单主模式下很难确认下一个PRIMARY
只能用在gtid模式的复制形式下，且日志格式必需为row</p></li></ul> <ul><li>MGR复制架构的适用场景
<ul><li>对主从延迟十分敏感的应用场景。</li> <li>希望可以对读写提供高可用的场景。</li> <li>希望可以保证数据强一致的场景。</li></ul></li></ul> <p><img src="/assets/img/image-20201212191631509.a5278479.png" alt="image-20201212191631509"></p> <p>为原DB增加Slave服务器</p> <p>进行读写分离，把读分担到Slave</p> <p>增加数据库中间层，进行负载均衡</p> <p><img src="/assets/img/image-20201212191734090.f3852d64.png" alt="image-20201212191734090"></p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/12/2020, 7:21:36 PM</span></div></footer> <!----> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1006bb4e.js" defer></script><script src="/assets/js/3.ecb1f808.js" defer></script><script src="/assets/js/5.2e521b8e.js" defer></script>
  </body>
</html>